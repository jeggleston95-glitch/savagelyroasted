<script>
  const stripe = Stripe('pk_live_51SPSCXFi6Ny79Mdfrsuyk4b3epGsTEaYESs2uXe3AYtc2yDa1BGZKgeQU5ejQAZgDDjrHTjs23kWerpQ4qAaVnBk000ZOLPBK9');
  const API_KEY = 'xai-YOUR-REAL-KEY-HERE'; // â† PASTE FROM console.x.ai
  let roastText = '';

  async function startRoast() {
    const target = document.getElementById('target-name').value.trim();
    if (!target) return alert("Victim required! ðŸ˜ˆ");

    document.getElementById('output').innerHTML = 'ðŸ”¥ Charging $1...';

    const response = await fetch('https://savage-roast-server.onrender.com/create-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target })
    });
    const session = await response.json();
    stripe.redirectToCheckout({ sessionId: session.id });
  }

  window.addEventListener('load', async () => {
    if (new URLSearchParams(window.location.search).get('success')) {
      const savedTarget = sessionStorage.getItem('roastTarget');
      if (savedTarget) await generateRoast(savedTarget);
    }
  });

  document.getElementById('target-name').addEventListener('input', () => {
    sessionStorage.setItem('roastTarget', document.getElementById('target-name').value);
  });

  async function generateRoast(target) {
    const output = document.getElementById('output');
    output.innerHTML = 'ðŸ”¥ Summoning hellfire...';

    const prompt = `Savagely roast ${target} â€” brutal, unhinged, no mercy. Dark humor, fire emojis. <100 words.`;

    try {
      const res = await fetch('https://api.x.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: 'grok-beta',
          messages: [{ role: 'user', content: prompt }],
          temperature: 1.4
        })
      });
      const data = await res.json();
      roastText = data.choices[0].message.content;
      output.innerHTML = roastText.replace(/\n/g, '<br>');
      document.getElementById('voice-btn').classList.remove('hidden');
      sessionStorage.clear();
    } catch (err) {
      output.innerHTML = 'API down! Try again ðŸ˜ˆ';
      console.error(err);
    }
  }

  function speakRoast() {
    const utter = new SpeechSynthesisUtterance(roastText);
    const voices = speechSynthesis.getVoices();
    utter.voice = voices.find(v => v.name.includes('Daniel')) || voices[0];
    utter.rate = 0.9; utter.pitch = 0.4; utter.volume = 1;
    speechSynthesis.speak(utter);
  }
</script>
